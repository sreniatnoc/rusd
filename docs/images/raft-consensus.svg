<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 500" width="900" height="500">
  <defs>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap');
      text { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    </style>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.3"/>
    </filter>
    <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4f46e5;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#16a34a;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowSlate" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
    </marker>
    <marker id="arrowWhite" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1"/>
    </marker>
    <!-- Glow for leader -->
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="500" fill="#0f172a"/>

  <!-- Title -->
  <text x="450" y="32" text-anchor="middle" fill="#f8fafc" font-size="18" font-weight="700" letter-spacing="0.5">Raft Consensus Protocol</text>
  <text x="450" y="50" text-anchor="middle" fill="#64748b" font-size="11" font-weight="400">3-node cluster: Leader election, log replication, and commit advancement</text>

  <!-- ==================== 3-NODE CLUSTER ==================== -->

  <!-- LEADER NODE (center-left) -->
  <rect x="60" y="80" width="250" height="170" rx="12" fill="#1e293b" stroke="#f97316" stroke-width="2" filter="url(#glow)"/>
  <rect x="60" y="80" width="250" height="30" rx="12" fill="url(#orangeGrad)"/>
  <rect x="60" y="98" width="250" height="12" fill="url(#orangeGrad)"/>
  <text x="185" y="100" text-anchor="middle" fill="#fff" font-size="13" font-weight="700">NODE 1 - LEADER</text>

  <rect x="78" y="120" width="214" height="24" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="185" y="136" text-anchor="middle" fill="#f97316" font-size="10" font-weight="600">RaftState: Leader (term=3)</text>

  <rect x="78" y="150" width="214" height="24" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="185" y="166" text-anchor="middle" fill="#cbd5e1" font-size="10" font-weight="500">RaftLog: [1..47]</text>

  <rect x="78" y="180" width="104" height="24" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="130" y="196" text-anchor="middle" fill="#94a3b8" font-size="9" font-weight="500">commit: 45</text>

  <rect x="188" y="180" width="104" height="24" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="240" y="196" text-anchor="middle" fill="#94a3b8" font-size="9" font-weight="500">applied: 45</text>

  <text x="185" y="230" text-anchor="middle" fill="#f97316" font-size="9" font-weight="500">propose() -> append to log -> replicate</text>

  <!-- FOLLOWER 1 (top-right) -->
  <rect x="590" y="68" width="270" height="128" rx="12" fill="#1e293b" stroke="#6366f1" stroke-width="1.5" filter="url(#shadow)"/>
  <rect x="590" y="68" width="270" height="28" rx="12" fill="url(#blueGrad)"/>
  <rect x="590" y="84" width="270" height="12" fill="url(#blueGrad)"/>
  <text x="725" y="88" text-anchor="middle" fill="#fff" font-size="12" font-weight="700">NODE 2 - FOLLOWER</text>

  <rect x="608" y="104" width="234" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="725" y="119" text-anchor="middle" fill="#6366f1" font-size="10" font-weight="600">RaftState: Follower (term=3)</text>

  <rect x="608" y="132" width="113" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="664" y="147" text-anchor="middle" fill="#cbd5e1" font-size="9">Log: [1..46]</text>

  <rect x="729" y="132" width="113" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="786" y="147" text-anchor="middle" fill="#94a3b8" font-size="9">match: 46</text>

  <text x="725" y="180" text-anchor="middle" fill="#64748b" font-size="9">handle_append_entries() -> append + ack</text>

  <!-- FOLLOWER 2 (bottom-right) -->
  <rect x="590" y="210" width="270" height="128" rx="12" fill="#1e293b" stroke="#6366f1" stroke-width="1.5" filter="url(#shadow)"/>
  <rect x="590" y="210" width="270" height="28" rx="12" fill="url(#blueGrad)"/>
  <rect x="590" y="226" width="270" height="12" fill="url(#blueGrad)"/>
  <text x="725" y="230" text-anchor="middle" fill="#fff" font-size="12" font-weight="700">NODE 3 - FOLLOWER</text>

  <rect x="608" y="246" width="234" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="725" y="261" text-anchor="middle" fill="#6366f1" font-size="10" font-weight="600">RaftState: Follower (term=3)</text>

  <rect x="608" y="274" width="113" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="664" y="289" text-anchor="middle" fill="#cbd5e1" font-size="9">Log: [1..45]</text>

  <rect x="729" y="274" width="113" height="22" rx="5" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="786" y="289" text-anchor="middle" fill="#94a3b8" font-size="9">match: 45</text>

  <text x="725" y="322" text-anchor="middle" fill="#64748b" font-size="9">handle_append_entries() -> append + ack</text>

  <!-- ==================== REPLICATION ARROWS ==================== -->

  <!-- Leader -> Follower 1: AppendEntries -->
  <path d="M310,140 C420,110 510,110 588,130" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <rect x="395" y="100" width="120" height="18" rx="4" fill="#f97316" opacity="0.15"/>
  <text x="455" y="113" text-anchor="middle" fill="#f97316" font-size="9" font-weight="600">AppendEntries</text>

  <!-- Follower 1 -> Leader: Response -->
  <path d="M588,155 C510,160 420,155 312,158" stroke="#22c55e" stroke-width="1.5" fill="none" stroke-dasharray="5,3" marker-end="url(#arrowGreen)"/>
  <rect x="400" y="152" width="110" height="16" rx="4" fill="#22c55e" opacity="0.1"/>
  <text x="455" y="164" text-anchor="middle" fill="#22c55e" font-size="8" font-weight="500">success: true, match: 46</text>

  <!-- Leader -> Follower 2: AppendEntries -->
  <path d="M310,200 C420,240 510,252 588,262" stroke="#f97316" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <rect x="395" y="235" width="120" height="18" rx="4" fill="#f97316" opacity="0.15"/>
  <text x="455" y="248" text-anchor="middle" fill="#f97316" font-size="9" font-weight="600">AppendEntries</text>

  <!-- Follower 2 -> Leader: Response -->
  <path d="M588,290 C510,295 420,275 312,218" stroke="#22c55e" stroke-width="1.5" fill="none" stroke-dasharray="5,3" marker-end="url(#arrowGreen)"/>
  <rect x="400" y="274" width="110" height="16" rx="4" fill="#22c55e" opacity="0.1"/>
  <text x="455" y="285" text-anchor="middle" fill="#22c55e" font-size="8" font-weight="500">success: true, match: 45</text>

  <!-- ==================== COMMIT ADVANCEMENT ==================== -->
  <rect x="60" y="270" width="480" height="66" rx="10" fill="#1e293b" stroke="#22c55e" stroke-width="1.2" filter="url(#shadow)"/>
  <text x="80" y="292" fill="#22c55e" font-size="12" font-weight="700">Commit Advancement (Majority)</text>

  <text x="80" y="310" fill="#cbd5e1" font-size="10">Leader checks: match_index = [46, 45] -> majority_match = 45</text>
  <text x="80" y="326" fill="#94a3b8" font-size="10">If majority_match > commit_index -> set_commit_index(45) -> apply_committed_entries()</text>

  <!-- ==================== ELECTION FLOW (BOTTOM) ==================== -->
  <rect x="30" y="352" width="840" height="136" rx="10" fill="#1e293b" stroke="#334155" stroke-width="1" filter="url(#shadow)"/>
  <text x="50" y="374" fill="#f8fafc" font-size="13" font-weight="700">Election Flow (with Pre-Vote)</text>

  <!-- Timeline -->
  <line x1="70" y1="400" x2="840" y2="400" stroke="#334155" stroke-width="1"/>

  <!-- Phase 1: Timeout -->
  <circle cx="100" cy="400" r="5" fill="#f97316"/>
  <text x="100" y="420" text-anchor="middle" fill="#f97316" font-size="9" font-weight="600">Timeout</text>
  <text x="100" y="434" text-anchor="middle" fill="#64748b" font-size="8">election timer</text>
  <text x="100" y="446" text-anchor="middle" fill="#64748b" font-size="8">expires</text>

  <!-- Arrow to PreVote -->
  <line x1="115" y1="400" x2="195" y2="400" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowSlate)"/>

  <!-- Phase 2: PreVote -->
  <rect x="200" y="386" width="130" height="28" rx="6" fill="#6366f1" opacity="0.2" stroke="#6366f1" stroke-width="1"/>
  <text x="265" y="404" text-anchor="middle" fill="#a5b4fc" font-size="10" font-weight="600">Pre-Vote</text>
  <text x="265" y="426" text-anchor="middle" fill="#64748b" font-size="8">RequestVote(pre=true)</text>
  <text x="265" y="438" text-anchor="middle" fill="#64748b" font-size="8">term = current + 1</text>
  <text x="265" y="450" text-anchor="middle" fill="#64748b" font-size="8">no term change</text>

  <!-- Arrow -->
  <line x1="335" y1="400" x2="385" y2="400" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowSlate)"/>
  <text x="360" y="393" text-anchor="middle" fill="#22c55e" font-size="8" font-weight="500">majority</text>

  <!-- Phase 3: Real Election -->
  <rect x="390" y="386" width="140" height="28" rx="6" fill="#f97316" opacity="0.2" stroke="#f97316" stroke-width="1"/>
  <text x="460" y="404" text-anchor="middle" fill="#fb923c" font-size="10" font-weight="600">Real Election</text>
  <text x="460" y="426" text-anchor="middle" fill="#64748b" font-size="8">become_candidate()</text>
  <text x="460" y="438" text-anchor="middle" fill="#64748b" font-size="8">increment term</text>
  <text x="460" y="450" text-anchor="middle" fill="#64748b" font-size="8">RequestVote(pre=false)</text>

  <!-- Arrow -->
  <line x1="535" y1="400" x2="585" y2="400" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowSlate)"/>
  <text x="560" y="393" text-anchor="middle" fill="#22c55e" font-size="8" font-weight="500">majority</text>

  <!-- Phase 4: Become Leader -->
  <rect x="590" y="386" width="130" height="28" rx="6" fill="#22c55e" opacity="0.2" stroke="#22c55e" stroke-width="1"/>
  <text x="655" y="404" text-anchor="middle" fill="#22c55e" font-size="10" font-weight="600">Become Leader</text>
  <text x="655" y="426" text-anchor="middle" fill="#64748b" font-size="8">become_leader()</text>
  <text x="655" y="438" text-anchor="middle" fill="#64748b" font-size="8">init next_index[]</text>
  <text x="655" y="450" text-anchor="middle" fill="#64748b" font-size="8">init match_index[]</text>

  <!-- Arrow -->
  <line x1="725" y1="400" x2="765" y2="400" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowSlate)"/>

  <!-- Phase 5: Heartbeats -->
  <rect x="770" y="386" width="80" height="28" rx="6" fill="#f97316" opacity="0.2" stroke="#f97316" stroke-width="1"/>
  <text x="810" y="404" text-anchor="middle" fill="#fb923c" font-size="10" font-weight="600">Heartbeat</text>
  <text x="810" y="426" text-anchor="middle" fill="#64748b" font-size="8">send_heartbeats()</text>
  <text x="810" y="438" text-anchor="middle" fill="#64748b" font-size="8">empty AE to</text>
  <text x="810" y="450" text-anchor="middle" fill="#64748b" font-size="8">all followers</text>

  <!-- ==================== PROTO SERVICE BOX ==================== -->
  <rect x="590" y="344" width="270" height="34" rx="8" fill="#0f172a" stroke="#475569" stroke-width="1"/>
  <text x="610" y="359" fill="#94a3b8" font-size="9" font-weight="600">raftpb.proto</text>
  <text x="610" y="372" fill="#64748b" font-size="8">AppendEntries | RequestVote | InstallSnapshot (stream)</text>
</svg>